<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Basketball Game</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100%;
    }
    
    html {
      height: 100%;
    }
    
    #game-container {
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    #canvas-container {
      width: 100%;
      height: 100%;
    }
    
    #ui-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      padding: 20px;
      pointer-events: none;
      z-index: 10;
    }
    
    #score-board {
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 25px;
      border-radius: 15px;
      display: inline-block;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    #score {
      font-size: 28px;
      font-weight: bold;
      margin: 0;
    }
    
    #attempts {
      font-size: 16px;
      margin: 5px 0 0 0;
      opacity: 0.7;
    }
    
    #instructions {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 30px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      pointer-events: none;
    }
    
    #instructions p {
      margin: 0;
      font-size: 16px;
      font-weight: 500;
    }
    
    #power-meter {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 200px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      overflow: hidden;
      border: 3px solid rgba(255, 255, 255, 0.5);
      display: none;
    }
    
    #power-fill {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: linear-gradient(to top, #4ade80, #fbbf24, #ef4444);
      transition: height 0.05s linear;
    }
    
    #game-title {
      font-size: 32px;
      font-weight: bold;
      margin: 0 0 10px 0;
    }
    
    #shooting-guide {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      display: none;
    }
    
    #angle-indicator {
      width: 100px;
      height: 100px;
      border: 2px solid #333;
      border-radius: 50%;
      position: relative;
      margin: 10px 0;
    }
    
    #angle-arrow {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 2px;
      height: 40px;
      background: #ef4444;
      transform-origin: bottom center;
      transform: translate(-50%, -100%) rotate(0deg);
      transition: transform 0.1s ease;
    }
    
    #angle-arrow::after {
      content: '';
      position: absolute;
      top: -5px;
      left: -3px;
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 8px solid #ef4444;
    }
    
    #position-controls {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      pointer-events: auto;
    }
    
    .position-btn {
      background: rgba(255, 255, 255, 0.95);
      border: none;
      padding: 10px 15px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }
    
    .position-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .position-btn.active {
      background: #4ade80;
      color: white;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="game-container">
   <div id="canvas-container"></div>
   <div id="ui-overlay">
    <div id="score-board">
     <h1 id="game-title">üèÄ 3D Basketball</h1>
     <p id="score">Score: 0</p>
     <p id="attempts">Shots: 0</p>
    </div>
   </div>
   <div id="instructions">
    <p id="instructions-text">Click and hold to aim, release to shoot!</p>
   </div>
   <div id="power-meter">
    <div id="power-fill"></div>
   </div>
   <div id="shooting-guide">
    <h3 style="margin: 0 0 10px 0; font-size: 16px;">Shooting Guide</h3>
    <p style="margin: 0 0 5px 0; font-size: 12px;">Angle:</p>
    <div id="angle-indicator">
     <div id="angle-arrow"></div>
    </div>
    <p style="margin: 5px 0 0 0; font-size: 12px;" id="angle-text">45¬∞</p>
   </div>
   <div id="position-controls"><button class="position-btn active" onclick="changePosition('center')">Center</button> <button class="position-btn" onclick="changePosition('left')">Left Side</button> <button class="position-btn" onclick="changePosition('right')">Right Side</button> <button class="position-btn" onclick="changePosition('corner')">Corner</button>
   </div>
  </div>
  <script>
    const defaultConfig = {
      game_title: "üèÄ 3D Basketball",
      instructions_text: "Click and hold to aim, release to shoot!",
      primary_color: "#667eea",
      secondary_color: "#ffffff",
      text_color: "#333333",
      hoop_color: "#ef4444",
      font_family: "Arial",
      font_size: 16
    };

    let scene, camera, renderer, basketball, hoop, hoopRim, backboard;
    let isCharging = false;
    let chargePower = 0;
    let score = 0;
    let attempts = 0;
    let ballInMotion = false;
    let ballVelocity = new THREE.Vector3();
    let gravity = -0.008;
    const maxChargePower = 100;
    const chargeRate = 2;
    let currentPosition = 'center';
    let mouseX = 0;
    let mouseY = 0;
    let shootingAngle = 45;
    let playerHeight = 1.8;
    
    const playerPositions = {
      center: { x: 0, y: playerHeight, z: 6 },
      left: { x: -4, y: playerHeight, z: 3 },
      right: { x: 4, y: playerHeight, z: 3 },
      corner: { x: -3, y: playerHeight, z: 4 }
    };

    function init() {
      try {
        const container = document.getElementById('canvas-container');
        
        // Scene setup
        scene = new THREE.Scene();
        scene.background = new THREE.Color(defaultConfig.primary_color);
        
        // Camera setup
        camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        const startPos = playerPositions[currentPosition];
        camera.position.set(startPos.x, startPos.y, startPos.z);
        camera.lookAt(0, 3, -5);
        
        // Renderer setup
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);
        
        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 5);
        directionalLight.castShadow = true;
        scene.add(directionalLight);
        
        // Court
        const courtGeometry = new THREE.PlaneGeometry(20, 20);
        const courtMaterial = new THREE.MeshStandardMaterial({ color: 0xd4a574 });
        const court = new THREE.Mesh(courtGeometry, courtMaterial);
        court.rotation.x = -Math.PI / 2;
        court.receiveShadow = true;
        scene.add(court);
        
        // Basketball
        const ballGeometry = new THREE.SphereGeometry(0.3, 32, 32);
        const ballMaterial = new THREE.MeshStandardMaterial({ color: 0xff6600 });
        basketball = new THREE.Mesh(ballGeometry, ballMaterial);
        basketball.position.set(startPos.x, startPos.y - 0.5, startPos.z - 0.5);
        basketball.castShadow = true;
        scene.add(basketball);
        
        // Pole
        const poleGeometry = new THREE.CylinderGeometry(0.1, 0.1, 6, 16);
        const poleMaterial = new THREE.MeshStandardMaterial({ color: 0x888888 });
        const pole = new THREE.Mesh(poleGeometry, poleMaterial);
        pole.position.set(0, 3, -5);
        pole.castShadow = true;
        scene.add(pole);
        
        // Backboard
        const backboardGeometry = new THREE.BoxGeometry(3, 2, 0.1);
        const backboardMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff });
        backboard = new THREE.Mesh(backboardGeometry, backboardMaterial);
        backboard.position.set(0, 5, -5.5);
        backboard.castShadow = true;
        scene.add(backboard);
        
        // Hoop rim
        const rimGeometry = new THREE.TorusGeometry(0.45, 0.05, 16, 32);
        const rimMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000 });
        hoopRim = new THREE.Mesh(rimGeometry, rimMaterial);
        hoopRim.position.set(0, 5, -5);
        hoopRim.rotation.x = Math.PI / 2;
        hoopRim.castShadow = true;
        scene.add(hoopRim);
        
        // Net
        const netGeometry = new THREE.CylinderGeometry(0.45, 0.5, 0.8, 16, 1, true);
        const netMaterial = new THREE.MeshBasicMaterial({ 
          color: 0xffffff, 
          wireframe: true,
          transparent: true,
          opacity: 0.6
        });
        const net = new THREE.Mesh(netGeometry, netMaterial);
        net.position.set(0, 4.6, -5);
        scene.add(net);
        
        hoop = hoopRim;
        
        // Event listeners
        window.addEventListener('resize', onWindowResize);
        container.addEventListener('mousedown', onMouseDown);
        container.addEventListener('mouseup', onMouseUp);
        container.addEventListener('mousemove', onMouseMove);
        container.addEventListener('touchstart', onMouseDown);
        container.addEventListener('touchend', onMouseUp);
        container.addEventListener('touchmove', onTouchMove);
        
        // Start animation loop
        animate();
        
      } catch (error) {
        console.error('Error initializing game:', error);
      }
    }

    function onWindowResize() {
      const container = document.getElementById('canvas-container');
      camera.aspect = container.clientWidth / container.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container.clientWidth, container.clientHeight);
    }

    function onMouseMove(event) {
      if (!isCharging) return;
      const container = document.getElementById('canvas-container');
      const rect = container.getBoundingClientRect();
      mouseX = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      mouseY = -((event.clientY - rect.top) / rect.height) * 2 + 1;
      updateShootingGuide();
    }
    
    function onTouchMove(event) {
      event.preventDefault();
      if (!isCharging) return;
      if (event.touches.length > 0) {
        const container = document.getElementById('canvas-container');
        const rect = container.getBoundingClientRect();
        mouseX = ((event.touches[0].clientX - rect.left) / rect.width) * 2 - 1;
        mouseY = -((event.touches[0].clientY - rect.top) / rect.height) * 2 + 1;
        updateShootingGuide();
      }
    }

    function onMouseDown(event) {
      event.preventDefault();
      if (!ballInMotion) {
        isCharging = true;
        chargePower = 0;
        document.getElementById('power-meter').style.display = 'block';
        document.getElementById('shooting-guide').style.display = 'block';
      }
    }

    function onMouseUp(event) {
      event.preventDefault();
      if (isCharging && !ballInMotion) {
        isCharging = false;
        document.getElementById('power-meter').style.display = 'none';
        document.getElementById('shooting-guide').style.display = 'none';
        shootBall();
      }
    }
    
    function updateShootingGuide() {
      shootingAngle = Math.max(10, Math.min(80, 45 + mouseY * 30));
      
      const arrowRotation = -shootingAngle + 90;
      document.getElementById('angle-arrow').style.transform = 
        `translate(-50%, -100%) rotate(${arrowRotation}deg)`;
      document.getElementById('angle-text').textContent = `${Math.round(shootingAngle)}¬∞`;
    }
    
    function changePosition(position) {
      if (ballInMotion) return;
      
      currentPosition = position;
      
      document.querySelectorAll('.position-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      const playerPos = playerPositions[position];
      
      camera.position.set(playerPos.x, playerPos.y, playerPos.z);
      camera.lookAt(0, 3, -5);
      
      basketball.position.set(playerPos.x, playerPos.y - 0.5, playerPos.z - 0.5);
    }

    function shootBall() {
      ballInMotion = true;
      attempts++;
      document.getElementById('attempts').textContent = `Shots: ${attempts}`;
      
      const power = Math.max(0.5, chargePower / maxChargePower);
      const hoopPosition = new THREE.Vector3(0, 5, -5);
      const ballPosition = basketball.position.clone();
      
      // Calculate direction to hoop
      const direction = hoopPosition.clone().sub(ballPosition).normalize();
      const distance = ballPosition.distanceTo(hoopPosition);
      
      // Simple physics
      const angleRad = (shootingAngle * Math.PI) / 180;
      const baseSpeed = power * 0.2 + 0.1;
      
      ballVelocity.x = direction.x * baseSpeed * Math.cos(angleRad) + mouseX * 0.02;
      ballVelocity.y = baseSpeed * Math.sin(angleRad) + 0.08;
      ballVelocity.z = direction.z * baseSpeed * Math.cos(angleRad) + mouseY * 0.01;
    }

    function checkScore() {
      const hoopCenter = new THREE.Vector3(0, 5, -5);
      const ballToHoop = basketball.position.clone().sub(hoopCenter);
      const horizontalDistance = Math.sqrt(ballToHoop.x * ballToHoop.x + ballToHoop.z * ballToHoop.z);
      
      if (horizontalDistance < 0.4 && 
          basketball.position.y < hoopCenter.y + 0.1 && 
          basketball.position.y > hoopCenter.y - 0.5 &&
          ballVelocity.y < 0) {
        
        score++;
        document.getElementById('score').textContent = `Score: ${score}`;
        
        // Ball color change
        basketball.material.color.setHex(0x00ff00);
        setTimeout(() => {
          basketball.material.color.setHex(0xff6600);
        }, 300);
        
        // Create swish effect
        createSwishEffect();
        
        resetBall();
        return true;
      }
      return false;
    }

    function createSwishEffect() {
      // Create swish particles
      const particleCount = 20;
      const particles = [];
      
      for (let i = 0; i < particleCount; i++) {
        const particleGeometry = new THREE.SphereGeometry(0.02, 8, 8);
        const particleMaterial = new THREE.MeshBasicMaterial({ 
          color: 0xffffff,
          transparent: true,
          opacity: 0.8
        });
        const particle = new THREE.Mesh(particleGeometry, particleMaterial);
        
        // Position particles around the hoop
        const angle = (i / particleCount) * Math.PI * 2;
        particle.position.set(
          Math.cos(angle) * 0.5,
          4.8,
          -5 + Math.sin(angle) * 0.5
        );
        
        // Random velocity for swish effect
        particle.velocity = new THREE.Vector3(
          (Math.random() - 0.5) * 0.02,
          Math.random() * 0.01 + 0.005,
          (Math.random() - 0.5) * 0.02
        );
        
        particles.push(particle);
        scene.add(particle);
      }
      
      // Animate particles
      let animationTime = 0;
      const animateSwish = () => {
        animationTime += 0.016; // ~60fps
        
        particles.forEach((particle, index) => {
          particle.position.add(particle.velocity);
          particle.velocity.y -= 0.0005; // gravity
          particle.material.opacity = Math.max(0, 0.8 - animationTime * 2);
          
          // Remove particle when invisible
          if (particle.material.opacity <= 0) {
            scene.remove(particle);
            particles.splice(index, 1);
          }
        });
        
        if (particles.length > 0 && animationTime < 1) {
          requestAnimationFrame(animateSwish);
        }
      };
      
      animateSwish();
      
      // Show "SWISH!" text effect
      showSwishText();
    }

    function showSwishText() {
      const swishElement = document.createElement('div');
      swishElement.textContent = 'SWISH!';
      swishElement.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 48px;
        font-weight: bold;
        color: #00ff00;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        pointer-events: none;
        z-index: 1000;
        animation: swishPop 1s ease-out forwards;
      `;
      
      // Add CSS animation
      if (!document.getElementById('swish-style')) {
        const style = document.createElement('style');
        style.id = 'swish-style';
        style.textContent = `
          @keyframes swishPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.getElementById('game-container').appendChild(swishElement);
      
      setTimeout(() => {
        if (swishElement.parentNode) {
          swishElement.parentNode.removeChild(swishElement);
        }
      }, 1000);
    }

    function resetBall() {
      setTimeout(() => {
        const playerPos = playerPositions[currentPosition];
        basketball.position.set(playerPos.x, playerPos.y - 0.5, playerPos.z - 0.5);
        ballVelocity.set(0, 0, 0);
        ballInMotion = false;
      }, 1000);
    }

    function animate() {
      requestAnimationFrame(animate);
      
      if (isCharging) {
        chargePower = Math.min(chargePower + chargeRate, maxChargePower);
        const powerPercent = (chargePower / maxChargePower) * 100;
        document.getElementById('power-fill').style.height = powerPercent + '%';
      }
      
      if (ballInMotion) {
        ballVelocity.y += gravity;
        basketball.position.add(ballVelocity);
        
        basketball.rotation.x += ballVelocity.length() * 0.2;
        basketball.rotation.z += ballVelocity.length() * 0.2;
        
        if (!checkScore()) {
          // Ground bounce
          if (basketball.position.y < 0.3) {
            basketball.position.y = 0.3;
            ballVelocity.y *= -0.5;
            ballVelocity.x *= 0.7;
            ballVelocity.z *= 0.7;
            
            if (Math.abs(ballVelocity.y) < 0.01 && Math.abs(ballVelocity.x) < 0.01 && Math.abs(ballVelocity.z) < 0.01) {
              resetBall();
            }
          }
          
          // Out of bounds
          if (basketball.position.z < -8 || basketball.position.z > 8 || 
              basketball.position.x < -8 || basketball.position.x > 8 ||
              basketball.position.y > 15) {
            resetBall();
          }
        }
      }
      
      renderer.render(scene, camera);
    }

    async function onConfigChange(config) {
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'Arial, sans-serif';
      
      document.getElementById('game-title').textContent = config.game_title || defaultConfig.game_title;
      document.getElementById('game-title').style.fontSize = `${baseSize * 2}px`;
      document.getElementById('game-title').style.fontFamily = `${customFont}, ${baseFontStack}`;
      document.getElementById('game-title').style.color = config.text_color || defaultConfig.text_color;
      
      document.getElementById('instructions-text').textContent = config.instructions_text || defaultConfig.instructions_text;
      document.getElementById('instructions-text').style.fontSize = `${baseSize}px`;
      document.getElementById('instructions-text').style.fontFamily = `${customFont}, ${baseFontStack}`;
      document.getElementById('instructions-text').style.color = config.text_color || defaultConfig.text_color;
      
      document.getElementById('score').style.fontSize = `${baseSize * 1.75}px`;
      document.getElementById('score').style.fontFamily = `${customFont}, ${baseFontStack}`;
      document.getElementById('score').style.color = config.text_color || defaultConfig.text_color;
      
      document.getElementById('attempts').style.fontSize = `${baseSize}px`;
      document.getElementById('attempts').style.fontFamily = `${customFont}, ${baseFontStack}`;
      document.getElementById('attempts').style.color = config.text_color || defaultConfig.text_color;
      
      document.getElementById('score-board').style.background = `${config.secondary_color || defaultConfig.secondary_color}`;
      document.getElementById('instructions').style.background = `${config.secondary_color || defaultConfig.secondary_color}`;
      
      if (scene) {
        scene.background = new THREE.Color(config.primary_color || defaultConfig.primary_color);
      }
      
      if (hoopRim) {
        hoopRim.material.color.set(config.hoop_color || defaultConfig.hoop_color);
      }
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => {
                config.primary_color = value;
                window.elementSdk.setConfig({ primary_color: value });
              }
            },
            {
              get: () => config.secondary_color || defaultConfig.secondary_color,
              set: (value) => {
                config.secondary_color = value;
                window.elementSdk.setConfig({ secondary_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.hoop_color || defaultConfig.hoop_color,
              set: (value) => {
                config.hoop_color = value;
                window.elementSdk.setConfig({ hoop_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: {
            get: () => config.font_family || defaultConfig.font_family,
            set: (value) => {
              config.font_family = value;
              window.elementSdk.setConfig({ font_family: value });
            }
          },
          fontSizeable: {
            get: () => config.font_size || defaultConfig.font_size,
            set: (value) => {
              config.font_size = value;
              window.elementSdk.setConfig({ font_size: value });
            }
          }
        }),
        mapToEditPanelValues: (config) => new Map([
          ["game_title", config.game_title || defaultConfig.game_title],
          ["instructions_text", config.instructions_text || defaultConfig.instructions_text]
        ])
      });
    }

    // Initialize when ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99b3a90b74abba08',t:'MTc2MjU5MDEyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
